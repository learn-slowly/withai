name: Update Indexes

on:
  push:
    branches: 
      - main
    paths:
      - 'content-production/**/*.md'
      - 'foreign-lang/**/*.md'
      - 'webdev/**/*.md'
      - '.github/workflows/update-indexes.yml'

jobs:
  update-indexes:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v3
      with:
        python-version: '3.x'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytz

    - name: Update indexes
      id: update
      run: |
        python3 - <<EOF
        import os
        from datetime import datetime
        import pytz
        import re
        
        def get_korean_time():
            kst = pytz.timezone('Asia/Seoul')
            now = datetime.now(kst)
            return now.strftime('%Y-%m-%d %H:%M:%S')
            
        def is_date_format(filename):
            pattern = r'^\d{8}\.md$'
            return bool(re.match(pattern, filename))
            
        def get_date_files(folder_path):
            if not os.path.exists(folder_path):
                return []
            return sorted([f for f in os.listdir(folder_path) if is_date_format(f)], reverse=True)
            
        def update_index_file(index_path, folder_path, is_foreign_lang=False):
            print(f"Processing {index_path}...")
            
            if not os.path.exists(index_path):
                print(f"Warning: {index_path} does not exist")
                return False
                
            with open(index_path, 'r', encoding='utf-8') as f:
                content = f.read()
                
            new_content = []
            updated = False
            lines = content.split('\n')
            
            if is_foreign_lang:
                en_files = get_date_files(os.path.join(folder_path, 'en'))
                jp_files = get_date_files(os.path.join(folder_path, 'jp'))
                
                in_section = None
                skip_old_dates = False
                
                for line in lines:
                    if line.strip() == '## English':
                        in_section = 'en'
                        skip_old_dates = True
                        new_content.append(line)
                        for f in en_files:
                            date = f"{f[:4]}-{f[4:6]}-{f[6:8]}"
                            new_content.append(f"- [{date}](en/{f})")
                    elif line.strip() == '## Japanese':
                        in_section = 'jp'
                        skip_old_dates = True
                        new_content.append(line)
                        for f in jp_files:
                            date = f"{f[:4]}-{f[4:6]}-{f[6:8]}"
                            new_content.append(f"- [{date}](jp/{f})")
                    elif line.startswith('#### Last updated:'):
                        new_content.append(f'#### Last updated: {get_korean_time()}')
                        updated = True
                    elif line.startswith('- 20') and skip_old_dates:
                        continue
                    else:
                        new_content.append(line)
                        skip_old_dates = False
            else:
                date_files = get_date_files(folder_path)
                after_title = False
                skip_old_dates = False
                
                for line in lines:
                    if line.startswith('# '):
                        after_title = True
                        new_content.append(line)
                    elif after_title and not skip_old_dates:
                        new_content.append(f'#### Last updated: {get_korean_time()}')
                        for f in date_files:
                            date = f"{f[:4]}-{f[4:6]}-{f[6:8]}"
                            new_content.append(f"- [{date}]({f})")
                        skip_old_dates = True
                        updated = True
                    elif line.startswith('#### Last updated:') or line.startswith('- 20'):
                        continue
                    else:
                        new_content.append(line)
            
            if updated:
                with open(index_path, 'w', encoding='utf-8') as f:
                    f.write('\n'.join(new_content))
                print(f"Updated {index_path}")
                return True
            return False
            
        # Update README.md first
        readme_updated = False
        if os.path.exists('README.md'):
            print("Updating README.md")
            with open('README.md', 'r', encoding='utf-8') as f:
                lines = f.readlines()
            
            new_lines = []
            for line in lines:
                if line.startswith('### Last updated:'):
                    new_lines.append(f'### Last updated: {get_korean_time()}\n')
                    readme_updated = True
                else:
                    new_lines.append(line)
            
            if readme_updated:
                with open('README.md', 'w', encoding='utf-8') as f:
                    f.writelines(new_lines)
                print("Updated README.md")
        
        # Get changed files and update indexes
        result = subprocess.run(['git', 'diff', '--name-only', 'HEAD^', 'HEAD'], 
                             capture_output=True, text=True)
        changed_files = result.stdout.splitlines()
        print("Changed files:", changed_files)
        
        any_updates = readme_updated
        
        if any(f.startswith('content-production/') for f in changed_files):
            any_updates |= update_index_file('content-production/index.md', 'content-production')
        
        if any(f.startswith('foreign-lang/') for f in changed_files):
            any_updates |= update_index_file('foreign-lang/index.md', 'foreign-lang', True)
        
        if any(f.startswith('webdev/') for f in changed_files):
            any_updates |= update_index_file('webdev/index.md', 'webdev')
            
        # Exit with status code
        exit(0 if any_updates else 1)
        EOF

    - name: Check for changes
      id: changes
      run: |
        git diff --quiet || echo "::set-output name=changed::true"

    - name: Commit changes
      if: steps.changes.outputs.changed == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add -A
        git commit -m "Update indexes"
        
    - name: Push changes
      if: steps.changes.outputs.changed == 'true'
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: ${{ github.ref }} 